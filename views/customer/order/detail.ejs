<% include ../header.ejs %>

<div style="position:relative;width:100%;height:100%;">
        <!--Layout-->
    <div class="site-layout">
            <!--If you add class "boxed" to .site-layout it wraps the whole document in a box, than you can simply add pattern background to body or leave it white. Please note in a "boxed" mode header doesn't stick to the top.-->
            <% include ../_nav_top.ejs %>
            <% include ../_nav_head.ejs %>
            <!--Header Close-->

        <div class="page">
            <div class="container">
                <div class="row">
                    <div style="position: fixed;z-index: 1022;left: 0;top: 0;background: #000;opacity:0.5;width: 100%;height: 100%;display: none" class="fadeDiv">
                    </div>
                    <div id="selectGoods" style="display:none;width:700px;height:900px">
                        <div style="font-size: 14px;padding: 4px;">
                            <div class="page-content space-top">
                                <section class="page-content-right">
                                    <aside class="page-content-right-head">
                                        <label>查看发货</label>
                                    </aside>
                                    <div class="form" style="padding:30px">
                                        <div class="row" style="margin-top:10px">
                                            <span class="col-sm-3">批次号:&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                            <input class="col-sm-9 inputBatchNum"  disabled />
                                        </div>
                                        <div class="row" style="margin-top:20px">
                                            <span class="col-sm-3">生产日期:</span>
                                            <input class="col-sm-9 cDatePicker  inputGoodsProduceDate" type="text" disabled/>
                                        </div>
                                        <div class="row" style="margin-top:20px">
                                            <span class="col-sm-3">
                                                有效期至:
                                            </span>
                                            <input class="col-sm-9 cDatePicker  inputGoodsValidDate" type="text" disabled/>
                                        </div>
                                        <div class="row" style="margin-top:20px">
                                            <span class="col-sm-3">
                                                数量:
                                            </span>
                                            <input class="col-sm-9 inputQuantity" type="text" disabled/>
                                        </div>
                                        <div class="row" style="margin-top:20px">
                                            <div class="col-sm-3" style="display: inline">
                                                <span style="vertical-align: top;">电子监管码：</span>
                                            </div>
                                            <textarea name="" style="height:150px;resize:none" id="" class="inputDrugESC col-sm-9" disabled></textarea>
                                        </div>
                                        <div class="row" style="margin-top:20px">
                                            <div class="col-sm-3" style="display: inline">
                                                <span style="vertical-align: top;">质检报告(附件):</span>
                                            </div>
                                            <div class="col-sm-9" style="padding: 0">
                                                <form class="form-signin" role="form" method="post" enctype='multipart/form-data' target="picture" style="display: none">
                                                    <div class="fileContainer">
                                                        <ul>
                                                        </ul>
                                                    </div>
                                                </form>
                                                <span style="display: none">暂无质检报告信息</span>
                                            </div>
                                        </div>
                                        <div class=" pull-right">
                                            <a class="btn btn-primary closeIframeGuide">关闭</a>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>


                    <!--Sidebar-->
                    <% var active = "order"; %>
                    <% include ../_order_sidebar.ejs %>
                    <!--Sidebar Close-->
                    <div class="col-md-10 pull-right space-top">
                        <div class="sm-panel-head content-flex-space-between">
                            <div>
                                订单号 :
                                <span class="orderId">
                                    <% if(data.order && data.order.id) {%>
                                    <a href="/order/detail?orderId=<%=data.order.id%>"><%= data.order.displayOrderId %></a>
                                    <% } %>
                                    <%
                                        if(data.shipInfo.length>0)
                                    {%>
                                        <% var shipInfo= data.shipInfo %>
                                    <%}%>
                                </span>
                                －
                                <span class="state">
                                    <%
                                    if(data.order && data.order.status) {%>
                                    <%= data._translation.OrderStatus[data.order.status]%>
                                    <% } %>
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-primary" id="reviewPurchaseDeal">查看电子合同</button>
                            </div>
                        </div>
                        <div class="sm-panel-content">
                            <div class="sm-order-timeline">
                                <% var historys = data.orderhistorys %>
                                <% var approveTime = "" %>
                                <% var shipTime = "" %>
                                <% var receiveTime = "" %>
                                <%
                                    var payTime = '';
                                    if(data.order.paymentStatus !=="UNPAID") {
                                        payTime = data.order.createdTime;
                                    }else{
                                    }
                                %>
                                <% for(var h in historys) { %>
                                <% if (historys[h].action == "APPROVE"){ %>
                                <% approveTime=historys[h].createdOn} %>
                                <% if (historys[h].action == "SHIP"){ %>
                                <% shipTime=historys[h].createdOn} %>
                                <% if (historys[h].action == "RECEIVE"){ %>
                                <% receiveTime=historys[h].createdOn} %>
                                <% } %>
                                <div class="tracking-timeline">
                                    <div class="timeline">
                                        <div class="checkpoint active" style="width: 180px;margin-left: 30px;">
                                            <span class="active"></span>
                                        </div>
                                        <% if( data.order.paymentStatus=="UNPAID"){%>
                                        <div class="checkpoint"><span></span></div>
                                        <%}else{%>
                                        <div class="checkpoint active"><span class="active"></span></div>
                                        <%}%>
                                        <% if(approveTime){%>
                                        <div class="checkpoint active"><span class="active"></span></div>
                                        <%}else{%>
                                        <div class="checkpoint "><span class=""></span></div>
                                        <%}%>
                                        <% if(shipTime){%>
                                        <div class="checkpoint active"><span class="active"></span></div>
                                        <%}else{%>
                                        <div class="checkpoint "><span class=""></span></div>
                                        <%}%>
                                        <% if(receiveTime){%>
                                        <div class="checkpoint last"><span class="active"></span></div>
                                        <%}else{%>
                                        <div class="checkpoint last"><span class=""></span></div>
                                        <%}%>
                                    </div>
                                    <div class="labels">
                                        <div style="width:148px"><span >提交订单</span><br/><span><%=data.order.createdTime%></span><i>25%</i></div>
                                        <div style="margin-left: 20px;width:148px"><span>支付成功</span><br/><span><%=payTime%></span><i>50%</i></div>
                                        <div style="margin-left: 20px;width:148px"><span>商家确认</span><br/><span><%=approveTime%></span><i>50%</i></div>
                                        <div style="margin-left: 20px;width:148px"><span>商家发货</span><br/><span><%=shipTime%></span><i>75%</i></div>
                                        <div style="margin-left: 20px;width:148px"><span>确认收货</span><br/><span><%=receiveTime%></span><i>100%</i></div>
                                    </div>
                                </div>
                            </div>
                            <div class="sm-order-history">
                                <div class="sm-order-history-head">
                                    <div>处理时间</div>
                                    <div>处理信息</div>
                                    <div>操作人</div>
                                </div>
                                <div class="sm-order-history-content" style="font-size: 12px;">
                                    <% var history = data.orderhistorys[0]%>
                                    <div><%=history.createdOn%></div>
                                    <div>
                                        <%= data._translation.OrderAction[history.action]%>
                                        <%if(history.remark){%> 【备注】<%=history.remark%><%}%>
                                        <%if(history.action =="CREATE" && history.orderId){%>
                                        【订单号】<a href="/order/detail?orderId=<%=history.orderId%>"><%=history.displayOrderId%>%></a>
                                        <%}%>
                                        <%if(history.action =="SHIP" && history.shipId){%>
                                        发货成功,【物流单号】<%=history.logisticsNo%>
                                        <%}%>
                                        <%if(history.action =="RECEIVE" && history.logisticsNo){%>
                                        <%}%>
                                        <%if(history.action =="REQUEST-RETURN" &&history.returnId){%>
                                        【退货单号】<a href="/order/return/detail?returnId=<%=history.returnId%>"><%=history.returnId%></a>
                                        【退货备注】<%=history.remark?history.remark:"无"%><br>
                                        <%}%>
                                    </div>
                                    <div>
                                        <%=history.operatorName%>
                                    </div>
                                </div>
                                <div class="panel-collapse collapse" id="collapse1" style="font-size: 12px;">
                                    <% for (var i = 1; i < data.orderhistorys.length; i++){%>
                                    <% var temp = data.orderhistorys[i]%>
                                    <div class="sm-order-history-content ">
                                        <div><%=temp.createdOn%></div>
                                        <div>
                                            <%= data._translation.OrderAction[temp.action]%>
                                            <%if(temp.remark){%> 【备注】<%=temp.remark%><%}%>
                                            <%if(temp.action =="CREATE" && temp.orderId){%>
                                            【订单号】<a href="/order/detail?orderId=<%=temp.orderId%>"><%=temp.displayOrderId%></a>
                                            <%}%>
                                            <%if(temp.action =="SHIP" && temp.shipId){%>
                                            【物流】<%=temp.logisticsNo%>
                                            <%}%>
                                            <%if(temp.action =="RECEIVE" && temp.logisticsNo){%>
                                            <%}%>
                                            <%if(temp.action =="REQUEST-RETURN" &&temp.returnId){%>
                                            【退货单号】<a href="/order/return/detail?returnId=<%=temp.returnId%>"><%=temp.returnId%></a>
                                            【退货备注】<%=temp.remark?temp.remark:"无"%><br>
                                            <%}%>
                                        </div>
                                        <div>
                                            <%=temp.operatorName%>
                                        </div>
                                    </div>
                                    <% } %>
                                </div>
                                <div class="sm-order-history-content-collapse" style="<%= data.orderhistorys.length>1?'':'display:none' %>">
                                    <a class="collapsed" id="showAllOrderInfo"  data-toggle="collapse" href="#collapse1">
                                        <span>查看更多</span>
                                        <i class="fa fa-arrow-down"></i></a>
                                </div>
                            </div>
                        </div>

                        <% if(data.shipInfo.length<=0){%>
                            <div class="space-top">
                            <table class="sm-page-table">
                                <thead>
                                <tr>
                                    <td class="goods-info">商品信息</td>
                                    <td>供价</td>
                                    <td>数量</td>
                                    <td>小计</td>
                                    <td>备注</td>
                                </tr>
                                </thead>
                                <tbody>
                                <% for(var j in data.order.cartItems) { %>
                                <% var item = data.order.cartItems[j]; %>
                                <tr class="cartItem" id='<%= item.id %>' goodsId='<%= item.id %>'>
                                    <td class="goods-info">
                                        <div class="goods-img">
                                            <img src="<%= item.img %>" alt="<%=item.commonName%>"/>
                                        </div>
                                        <div class="goods-name-info">
                                            <h6><a href="/goods/detail?goodsId=<%=item.goodsId%>"><%=item.commonName%></a></h6>
                                            <h6><%=item.producer%></h6>
                                            <h6><%= item.spec%></h6>
                                            <div class="goods-name-box">
                                                <%if(item.isNationalMedicine == "1"){%>
                                                <div class="base-medical-sign" title="国家基本药品">基</div>
                                                <% } else {%>
                                                <% } %>

                                                <%if(item.isMedicalInsuranceDrugs == "1"){%>
                                                <div class="medical-sign" title="医保药品">医</div>
                                                <% } else {%>
                                                <% } %>

                                                <%if(item.isPrescriptionDrugs == "1"){%>
                                                <div class="prescriptions-sign" title="处方药品">处</div>
                                                <% } else {%>
                                                <% } %>

                                                <% if (item.isSplit=="1") { %>
                                                <div class="dismantle-sign" title="可拆零">拆</div>
                                                <% } else {%>
                                                <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        &yen;<label>
                                            <%= item.soldPrice.toFixed(data.pointDigit.DEFAULT) %>
                                        </label>
                                    </td>
                                    <td>
                                        <label for="" class="cartItem_quantity " >
                                            <%= item.quantity %>
                                        </label>
                                    </td>
                                    <td class="text-mcolor">
                                        &yen;<label for="" class="cartItem_amount"><%= item.amount.toFixed(data.pointDigit.DEFAULT) %></label>
                                    </td>
                                    <td>
                                        <span><%= item.remark ? item.remark : "无" %></span>
                                    </td>
                                </tr>
                                <% } %>
                                <tr>
                                    <td colspan="3" class="goods-info">
                                        <div>【支付方式】<%= data._translation.StatementMonthDetailPaymentType[data.order.paymentType]%></div>
                                    </td>
                                    <td colspan="4" class="text-end">
                                        <h4 style="margin-bottom: 0;">总计：<span class="text-mcolor" style="font-size: 16px;">&yen;<%=data.order.total.toFixed(data.pointDigit.DEFAULT)%></span></h4>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7" class="goods-info">
                                        <div>【发票信息】
                                            <%if(true==data.order.hasReceipt){%>
                                            发票抬头 : <span><%= data.order.receiptTitle%></span>
                                            <% } else{%>
                                            不需要发票
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7" class="goods-info">
                                        <div>【订单备注】 &nbsp;<span><%= data.order.remark ? data.order.remark : "无" %></span></div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <%if(data.order.status=="UNPAID"){%>
                                <div class="space-top pull-right">
                                    <a class="btn btn-primary" href="/order/payment?o=<%= data.order.id%>">去付款</a>
                                </div>
                            <%}%>
                        </div>
                        <%}else{%>
                        <% for(var index in shipInfo){%>
                        <% var shipDetails=shipInfo[index];%>
                        <div class="space-top">
                            <table class="sm-page-table space-bottom">
                                <thead>
                                <tr>
                                    <td class="goods-info"><strong>商品信息</strong></td>
                                    <td><strong>货号</strong></td>
                                    <td><strong>订单数量</strong></td>
                                    <td><strong>发货数量</strong></td>
                                    <td><strong>单价</strong></td>
                                    <td><strong>［批次］/数量</strong></td>
                                    <td><strong>小计</strong></td>
                                </tr>
                                </thead>
                                <tbody>
                                <% var old_goodsId = -1%>
                                <% var priceSum=0; %>
                                <% var temp=[]; %>
                                <% var temps=[]; %>
                                <% for(var i in shipDetails){%>
                                <% var shipinfo = shipDetails[i]%>
                                <% if(shipinfo.goodsId != old_goodsId){%>
                                <% old_goodsId = shipinfo.goodsId%>
                                <% old_goodsId = (shipinfo.orderQuantity !== shipinfo.shippedQuantitySum)?shipinfo.goodsId : ''%>
                                <% temp.push(old_goodsId);%>
                                <% temps.push(shipinfo.goodsId);%>
                                <tr class="goodsItem" goodsId="<%=old_goodsId%>">
                                    <td class="goods-info">
                                        <div class="goods-img" style="margin-top: 40px;">
                                            <img src="<%= shipinfo.imageUrl%>"/>
                                        </div>
                                        <div class="goods-name-info">
                                            <h6><a href="/goods/detail?goodsId=<%=shipinfo.goodsId%>"><%=shipinfo.commonName%><%if(shipinfo.alias){%>(<%=shipinfo.alias%>)<%}%></a></h6>
                                            <h6><%=shipinfo.producer%></h6>
                                            <h6><%=shipinfo.spec%></h6>
                                            <div class="goods-name-box">
                                                <%if(shipinfo.isNationalMedicine == "1"){%>
                                                <div class="base-medical-sign" title="国家基本药品">基</div>
                                                <% } else {%>
                                                <% } %>

                                                <%if(shipinfo.isMedicalInsuranceDrugs == "1"){%>
                                                <div class="medical-sign" title="医保药品">医</div>
                                                <% } else {%>
                                                <% } %>

                                                <%if(shipinfo.isPrescriptionDrugs == "1"){%>
                                                <div class="prescriptions-sign" title="处方药品">处</div>
                                                <% } else {%>
                                                <% } %>

                                                <% if (shipinfo.isSplit=="1") { %>
                                                <div class="dismantle-sign" title="可拆零">拆</div>
                                                <% } else {%>
                                                <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <%=shipinfo.goodsNo%>
                                    </td>
                                    <td>
                                        <%=shipinfo.orderQuantity%>
                                    </td>
                                    <% var fontColor = (shipinfo.orderQuantity == shipinfo.shippedQuantitySum) ? "font-green" : "font-orange"%>
                                    <td class="<%= fontColor%>  receivedQty_<%=shipinfo.goodsId%>"><%= shipinfo.shippedQuantitySum%></td>
                                    <td>&yen;<%= shipinfo.soldPrice.toFixed(2)%></td>
                                    <td name="batch_<%= old_goodsId%>">
                                        <% for(var j in shipDetails){%>
                                        <% var batchItem = shipDetails[j]%>
                                        <% if (batchItem.goodsId == shipinfo.goodsId){%>
                                        <div class="ship-operator">
                                            <div>
                                                [<span><%=batchItem.batchNum%></span>]/
                                                <span name="quantity"><%=batchItem.shippedQuantity%></span>
                                                <span><%=batchItem.measureUnit%></span>
                                            </div>
                                            <div>
                                                <a class="tooltipped" id="customerDisplayShipInfo_<%= shipinfo.goodsId%>_<%= batchItem.batchNum%>" title="查看" data-toggle="tooltip" data-placement="left"
                                                   batchNum="<%=batchItem.batchNum%>"
                                                   shipTotal="<%=shipinfo.shippedQuantitySum%>"
                                                   goodsId="<%=shipinfo.goodsId%>"
                                                   shipbatchqty="<%=batchItem.shippedQuantity%>"
                                                   batchQty="<%=batchItem.shippedQuantity%>"
                                                   produceDate="<%=batchItem.goodsProduceDate%>"
                                                   validDate="<%=batchItem.goodsValidDate%>"
                                                   drugESC="<%=batchItem.drugESC%>"
                                                   inspectReportURL="<%=batchItem.inspectReportURL%>">
                                                    <i class="fa fa-binoculars"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <% } %>
                                        <% } %>
                                    </td>
                                    <%
                                        var singleSum= Number(shipinfo.soldPrice.toFixed(2)*Number(shipinfo.shippedQuantitySum)).toFixed(2);
                                        priceSum=Number(priceSum)+Number(singleSum);
                                    %>
                                    <td>&yen;<%= singleSum%></td>
                                </tr>
                                <%}%>
                                <%}%>
                                <% for(var orderIndex in data.order.cartItems){%>
                                <% var orderInfoGoodsId = data.order.cartItems[orderIndex].goodsId%>

                                <% if(temps.indexOf(orderInfoGoodsId) == -1 ){%>
                                <% var tempGoodsInfo = data.order.cartItems[orderIndex]%>
                                <tr>
                                    <td class="goods-info">
                                        <div class="goods-img">
                                            <img src="<%= tempGoodsInfo.img%>"/>
                                        </div>
                                        <div class="goods-name-info">
                                            <h6><a href="/goods/detail?goodsId=<%=tempGoodsInfo.goodsId%>"><%=tempGoodsInfo.commonName%><%if(tempGoodsInfo.alias){%>(<%=tempGoodsInfo.alias%>)<%}%></a></h6>
                                            <h6><%=tempGoodsInfo.producer%></h6>
                                            <h6><%=tempGoodsInfo.spec%></h6>
                                        </div>
                                    </td>
                                    <td><%= tempGoodsInfo.goodsNo%></td>
                                    <td><%= tempGoodsInfo.quantity%></td>
                                    <td><%= tempGoodsInfo.shippedQuantity%></td>
                                    <td>&yen;<%= tempGoodsInfo.soldPrice.toFixed(2)%></td>
                                    <td>无</td>
                                    <td>0</td>
                                </tr>
                                <% } %>
                                <% } %>
                                <tr>
                                    <td colspan="7" class="goods-info">
                                        <%if(true==shipDetails[0].hasReceipt){%>
                                        <div>发票抬头:  <span><%= commonDetail.receiptTitle%></span></div>
                                        <% } else{%>
                                        <div>不需要发票</div>
                                        <% } %>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7" class="text-end">
                                        <div>
                                            <span>总计：</span>
                                            <span class="text-mcolor" style="font-size:16px">&yen;<%= priceSum.toFixed(2)%></span>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <%}%>
                        <% if(typeof shipDetails != "undefined" && shipDetails.length > 0){ %>
                        <div class="space-top">
                            <table class="sm-page-table">
                                <thead>
                                <tr>
                                    <td class="goods-info"><strong>发货信息</strong></td>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="goods-info">［开单日期］<%=shipDetails[0].orderTime%></td>
                                </tr>
                                <tr>
                                    <td class="goods-info">［发货日期］<%=shipDetails[0].shipTime%></td>
                                </tr>
                                <tr>
                                    <td class="goods-info">［物流信息］<%=shipDetails[0].logisticsNo%></td>
                                </tr>
                                <tr>
                                    <td class="goods-info">［发货备注］<%=shipDetails[0].remark?shipDetails[0].remark:"无"%></td>
                                </tr>
                                <% if (data.order.status == "SHIPPED"){%>
                                <tr>
                                    <td class="goods-info">［收货备注］
                                        <input class="receivedRemark" placeholder="添加备注" style="line-height: 30px;width:50%"/>
                                    </td>
                                </tr>
                                <% } %>
                                <% if (data.order.status == "FINISHED" || data.order.status == "RETURNED"){%>
                                <tr>
                                    <td class="goods-info">［收货备注］<%=shipDetails[0].receiveRemark?shipDetails[0].receiveRemark:"无"%></td>
                                </tr>
                                <% } %>
                                <% if (data.order.status == "RETURNED"){%>
                                <tr>
                                    <td class="goods-info">［申退备注］<%=data.returnInfo[0].applyReturnRemak?data.returnInfo[0].applyReturnRemak:"无"%></td>
                                </tr>
                                <% } %>
                                </tbody>
                            </table>
                        </div>
                        <% } %>
                        <div class="space-top pull-right space-bottom">
                            <% if (data.order.status == "SHIPPED"){%>
                            <a id="smClientConfirmReceived" class="btn btn-primary" shipId="<%=shipDetails[0].shipId%>">收货</a>
                            <a href="/order/return/apply?shipId=<%= shipDetails[0].shipId%>" class="btn btn-primary">我要退货</a>
                            <% } else if (data.order.status == "UNPAID"){%>
                            <a href="/order/payment?o=<%= data.order.id%>">去付款</a>
                            <a class="tooltipped clientCancelDialog" orderId="<%= shipDetails[0].orderId %>">取消</a>
                            <% } else if (data.order.status == "FINISHED"){%>
                            <a href="/order/return/apply?shipId=<%= shipDetails[0].shipId%>" class="btn btn-primary">我要退货</a>
                            <% } else if (data.order.status == "RETURNED"){%>
                            <a href="/order/return/apply?shipId=<%= shipDetails[0].shipId%>" class="btn btn-primary">我要退货</a>
                            <a href="/order/return?kv= <%= data.order.displayOrderId %>" class="btn btn-primary">查看退货</a>
                            <% }%>
                        </div>
                        <%}%>
                    </div>
                </div>
            </div>
        </div>
        </div>
    <% include ../_nav_bottom.ejs %>
    <%include ../purchaseDeal.ejs%>
</div>
<% include ../footer.ejs %>
<script  type="text/javascript" src="/static/source/js/customer/ship.js"></script>